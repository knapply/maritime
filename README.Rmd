---
title: "`{maritime}` ‚öì üö¢ ‚õµ üõ•Ô∏è"
output:
  github_document:
    html_preview: true
    toc: true
    toc_depth: 2
  html_document:
    keep_md: yes
always_allow_html: yes
editor_options: 
  chunk_output_type: console
---

<!-- README.Rmd generates README.md. -->

```{r, echo=FALSE}
knitr::opts_chunk$set(
  # collapse = TRUE,
  fig.align = "center",
  comment = "#>",
  fig.path = "man/figures/",
  message = FALSE,
  warning = FALSE
)
options(width = 150)
```


<!-- badges: start -->
[![R build status](https://github.com/knapply/maritime/workflows/R-CMD-check/badge.svg)](https://github.com/knapply/maritime/actions?workflow=R-CMD-check)
[![AppVeyor build status](https://ci.appveyor.com/api/projects/status/github/knapply/maritime?branch=master&svg=true)](https://ci.appveyor.com/project/knapply/maritime)
[![Travis-CI Build Status](https://travis-ci.org/knapply/maritime.svg?branch=master)](https://travis-ci.org/knapply/maritime)
[![Codecov test coverage](https://codecov.io/gh/knapply/maritime/branch/master/graph/badge.svg)](https://codecov.io/gh/knapply/maritime?branch=master)
[![Lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![GitHub last commit](https://img.shields.io/github/last-commit/knapply/maritime.svg)](https://github.com/knapply/maritime/commits/master)
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![Depends](https://img.shields.io/badge/Depends-GNU_R>=3.6-blue.svg)](https://www.r-project.org/)
[![GitHub code size in bytes](https://img.shields.io/github/languages/code-size/knapply/maritime.svg)](https://github.com/knapply/maritime)
[![Gitter](https://badges.gitter.im/maritime/community.svg)](https://gitter.im/maritime/community?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge)
[![HitCount](http://hits.dwyl.io/knapply/maritime.svg)](http://hits.dwyl.io/knapply/maritime)
<!-- [![CRAN status](https://www.r-pkg.org/badges/version/maritime)](https://cran.r-project.org/package=maritime) -->
<!-- badges: end -->

# Introduction

# Installation

You'll need a C++ compiler. If you're using Windows, that means [Rtools](https://cran.r-project.org/bin/windows/Rtools/).

```{r, eval=FALSE}
if (!requireNamespace("remotes", quietly = TRUE)) install.packages("remotes")
remotes::install_github("knapply/maritime")
```


# Usage

```{r}
library(maritime)
```


# Performance

```{r}
nmea_file <- "inst/example-data/big-files/20181210.log"
paste(round(file.size(nmea_file) / 1e9, 2L), "GB")
```

```{r}
options(maritime_verbose = FALSE)

library(sf)
library(tibble)

warm_ups <- bench::mark(
  warm_up1 = maritime:::.ais_decode_filter_file_impl(nmea_file, msg_type = ais_msgs$msg_1_2_3, as_sf = FALSE, as_tibble = FALSE, verbose = FALSE),
  warm_up2 = maritime:::.ais_decode_filter_file_impl(nmea_file, msg_type = ais_msgs$msg_1_2_3, as_sf = FALSE, as_tibble = FALSE, verbose = FALSE)
  ,
  iterations = 1,
  check = FALSE
)

bench_marks <- bench::mark(
  `plain data.frame` = ais_df <- ais_decode_filter(nmea_file, as_sf = FALSE, as_tibble = FALSE),
  `sf data.frame` = ais_sf_df <- ais_decode_filter(nmea_file, as_tibble = FALSE),
  `tibble` = ais_tbl <- ais_decode_filter(nmea_file, as_sf = FALSE),
  `sf tibble` = ais_sf_tbl <- ais_decode_filter(nmea_file)
  ,
  `tibble::as_tibble()` = as_tibble(ais_decode_filter(nmea_file, as_sf = FALSE, as_tibble = FALSE)),
  `sf::st_as_sf(tibble::as_tibble())` = st_as_sf(as_tibble(ais_decode_filter(nmea_file, as_sf = FALSE, as_tibble = FALSE)), coords = c("lng_deg", "lat_deg"), crs = 4326L),
  `sf::st_as_sf()` = st_as_sf(ais_decode_filter(nmea_file, as_sf = FALSE, as_tibble = FALSE), coords = c("lng_deg", "lat_deg"), crs = 4326L)
  ,
  iterations = 1,
  check = FALSE,
  filter_gc = FALSE
)

rbind(warm_ups, bench_marks)
```

```{r}
ais_sf_tbl
```


```{r, eval=FALSE, echo=FALSE}
# library(maritime)
files <- dir("inst/example-data/big-files/", full.names = TRUE)

lil_lines <- readLines("inst/example-data/20181101.log")
.vdm(lil_lines)

.read_lines(files[[1]])
.read_mmap(files[[1]])

lines1 <- readr::read_lines("inst/example-data/big-files/20181219.log", n_max = 1000)
(test <- .vdm(lines1))

msg5s <- stringr::str_subset(lines1, "^\\![A-Z]{5},\\d,\\d,\\d,.,5")
msg5s[1:10]
.vdm(msg5s)
.vdm(msg5s)
.vdm("!AIVDM,1,1,,A,15N:pmP002Jd``FGB:hm619`00R5,0*42")
.vdm("!SAVDM,1,1,6,A,15N4uK0P00r<rW:BFp;JJgv`25k`,0*49")
.vdm("!BSVDM,2,1,9,A,53KPtl01pv8`tTtR22050thhtr2222222222220l1`A916Vh0;20DPSmD`0D,0*21")
# all_lines <- c(readr::read_lines(files[[1]]), readr::read_lines(files[[2]]))
# cumsum(nchar(lines1))
# lines2 <- readr::read_lines(files[[2]])
# all_lines <- c(lines1, lines2)
# max(nchar(all_lines))
# range(nchar(all_lines))
# hist(nchar(all_lines))
# lines1[1:]
.vdm(c(
"$GPZDA,203003.00,12,07,2009,00,00,*47",
"!AIVDM,1,1,,B,23?up2001gGRju>Ap:;R2APP08:c,0*0E",
"!BSVDM,1,1,,A,15Mj23`PB`o=Of>KjvnJg8PT0L2R,0*7E",
"!SAVDM,1,1,,B,35Mj2p001qo@5tVKLBWmIDJT01:@,0*33",
"!AIVDM,1,1,,A,B5NWV1P0<vSE=I3QdK4bGwoUoP06,0*4F",
"!SAVDM,1,1,,A,403Owi1utn1W0qMtr2AKStg020S:,0*4B",
"!SAVDM,2,1,4,A,55Mub7P00001L@;SO7TI8DDltqB222222222220O0000067<0620@jhQDTVG,0*43",
"!SAVDM,2,2,4,A,30H88888880,2*49",
"$GPZDA,203003.00,12,07,2009,00,00,*47",
"!AIVDM,1,1,,B,23?up2001gGRju>Ap:;R2APP08:c,0*0E",
"!BSVDM,1,1,,A,15Mj23`PB`o=Of>KjvnJg8PT0L2R,0*7E",
"!SAVDM,1,1,,B,35Mj2p001qo@5tVKLBWmIDJT01:@,0*33",
"!AIVDM,1,1,,A,B5NWV1P0<vSE=I3QdK4bGwoUoP06,0*4F",
"!SAVDM,1,1,,A,403Owi1utn1W0qMtr2AKStg020S:,0*4B",
"!SAVDM,2,1,4,A,55Mub7P00001L@;SO7TI8DDltqB222222222220O0000067<0620@jhQDTVG,0*43",
"!SAVDM,2,2,4,A,30H88888880,2*49",
"$GPZDA,203003.00,12,07,2009,00,00,*47",
"!AIVDM,1,1,,B,23?up2001gGRju>Ap:;R2APP08:c,0*0E",
"!BSVDM,1,1,,A,15Mj23`PB`o=Of>KjvnJg8PT0L2R,0*7E",
"!SAVDM,1,1,,B,35Mj2p001qo@5tVKLBWmIDJT01:@,0*33",
"!AIVDM,1,1,,A,B5NWV1P0<vSE=I3QdK4bGwoUoP06,0*4F",
"!SAVDM,1,1,,A,403Owi1utn1W0qMtr2AKStg020S:,0*4B",
"!SAVDM,2,1,4,A,55Mub7P00001L@;SO7TI8DDltqB222222222220O0000067<0620@jhQDTVG,0*43",
"!SAVDM,2,2,4,A,30H88888880,2*49"
))
# files <- rep(files, 3)
# length(files)
# paste(round(sum(file.size(files)) / 1e9, 2L), "GB")

# test <- .ais_decode_filter_file_impl(
  # files, ais_msgs$msg_1_2_3,
  # as_tibble = T, as_sf = F, verbose = TRUE
  # )
# scales::comma(length(test))
test1 <- .ais_decode_file1(files[[1]],as_df = FALSE, verbose = TRUE)
decoded <- .ais_decode_filter_file_impl(files[[1]], 
                                        msg_type = ais_msgs$msg_1_2_3, 
                                        verbose = TRUE)

# ais_decode_filter(files)
bench_mark <- bench::mark(
  # new = .ais_decode_filter_file_impl(files[[2]], msg_type = ais_msgs$msg_1_2_3, 
                                      # verbose = FALSE),
  # old = .ais_decode_file1(files[[2]], as_df = FALSE, verbose = FALSE), 
  read_lines = .read_lines(files[[2]]),
  read_mmap = .read_mmap(files[[2]]),

  ,
  iterations = 3,
  check = FALSE
)

bench_mark
tibble::as_tibble(decoded)
```


# Credits

* AIS decoding routines are built on top of [Kurt Schwehr](https://twitter.com/kurtschwehr)'s [__libais__](https://github.com/schwehr/libais).



# Dev Notes

Message 5, single line

```
!BSVDM,2,1,9,A,53KPtl01pv8`tTtR22050thhtr2222222222220l1`A916Vh0;20DPSmD`0D,0*21
```

more message 5s

```
!AIVDM,2,1,0,A,58wt8Ui`g??r21`7S=:22058<v05Htp000000015>8OA;0sk,0*7B 
!AIVDM,2,2,0,A,eQ8823mDm3kP00000000000,2*5D

# nchar("58wt8Ui`g??r21`7S=:22058<v05Htp000000015>8OA;0skeQ8823mDm3kP00000000000")
# 71
```

